<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kai Ika – Daily Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-slate-50 to-cyan-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ---------- CONSTANT DATA ---------- */

const PRODUCTS = [
  "Blue Nose (Lg)","Blue Nose (Sml)","Coke","Coke Zero","Crispy Batter",
  "Donation","Gurnard","Hapuku (Lg)","Hapuku (Sml)","John Dory","Kahawai",
  "Tee Shirt","King Fillet","King Steaked","Knife - Gill & Gut",
  "Knife - Set","Knife - Filleting","Knife - Skinning",
  "Knife - Steaking","L&P","Mackeral","Mahi","Marlin (Lg)",
  "Marlin (Sml)","Panko batter","Shake n Bake batter","Knife sharpening",
  "Sistema 3.8L","Snapper","SNA Scale & Fillet","SNA Scale Gut & Gill",
  "SNA Scale only","Sprite","Tarakihi","Tempura Batter","Trevally",
  "Tuna (Lg)","Tuna (Med)","Tuna (Sml)"
];

const STAFF = ["Ben","Connor","Dave","Opu","Matt","Jay"];

const TASKS = ["Filleting","Distributions","Scotts","Cans"];

/* ---------- APP ---------- */

function App() {
  const [webAppUrl, setWebAppUrl] = useState(localStorage.getItem("webAppUrl") || "");
  const [configured, setConfigured] = useState(!!localStorage.getItem("webAppUrl"));

  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);

  const [date, setDate] = useState(localStorage.getItem("date") || new Date().toISOString().slice(0,10));
  const [formCompletedBy, setFormCompletedBy] = useState(localStorage.getItem("formCompletedBy") || "");
  const [totalSales, setTotalSales] = useState(localStorage.getItem("totalSales") || "");
  const [binsGenerated, setBinsGenerated] = useState(localStorage.getItem("binsGenerated") || "");
  const [binsDistributed, setBinsDistributed] = useState(localStorage.getItem("binsDistributed") || "");

  const [products, setProducts] = useState(JSON.parse(localStorage.getItem("products") || '[{"name":"","quantity":""}]'));
  const [staff, setStaff] = useState(JSON.parse(localStorage.getItem("staff") || '[{"name":"","task":"Filleting","start":"","end":""}]'));

  /* ---------- AUTOSAVE ---------- */
  useEffect(() => {
    localStorage.setItem("date", date);
    localStorage.setItem("formCompletedBy", formCompletedBy);
    localStorage.setItem("totalSales", totalSales);
    localStorage.setItem("binsGenerated", binsGenerated);
    localStorage.setItem("binsDistributed", binsDistributed);
    localStorage.setItem("products", JSON.stringify(products));
    localStorage.setItem("staff", JSON.stringify(staff));
  }, [date, formCompletedBy, totalSales, binsGenerated, binsDistributed, products, staff]);

  /* ---------- SUBMIT ---------- */
  const submit = async e => {
    e.preventDefault();
    setLoading(true);
    setSuccess(false);

    try {
      const fd = new FormData();

      const timestamp = new Date().toISOString();

      // DAY row
      fd.append("Row Type", "DAY");
      fd.append("Date", date);
      fd.append("Form Completed By", formCompletedBy);
      fd.append("Submission Timestamp", timestamp);
      fd.append("Total Sales", totalSales);
      fd.append("Bins Generated", binsGenerated);
      fd.append("Bins Distributed", binsDistributed);
      fd.append("Product Name", "");
      fd.append("Quantity", "");
      fd.append("Staff Name", "");
      fd.append("Task", "");
      fd.append("Start Time", "");
      fd.append("End Time", "");

      // PRODUCT rows
      products.forEach(p => {
        fd.append("Row Type", "PRODUCT");
        fd.append("Date", date);
        fd.append("Form Completed By", formCompletedBy);
        fd.append("Submission Timestamp", timestamp);
        fd.append("Total Sales", "");
        fd.append("Bins Generated", "");
        fd.append("Bins Distributed", "");
        fd.append("Product Name", p.name);
        fd.append("Quantity", p.quantity);
        fd.append("Staff Name", "");
        fd.append("Task", "");
        fd.append("Start Time", "");
        fd.append("End Time", "");
      });

      // STAFF rows
      staff.forEach(s => {
        fd.append("Row Type", "STAFF");
        fd.append("Date", date);
        fd.append("Form Completed By", formCompletedBy);
        fd.append("Submission Timestamp", timestamp);
        fd.append("Total Sales", "");
        fd.append("Bins Generated", "");
        fd.append("Bins Distributed", "");
        fd.append("Product Name", "");
        fd.append("Quantity", "");
        fd.append("Staff Name", s.name);
        fd.append("Task", s.task);
        fd.append("Start Time", s.start);
        fd.append("End Time", s.end);
      });

      const res = await fetch(webAppUrl, { method:"POST", body:fd });
      const json = await res.json();
      if (!json.success) throw new Error(json.error);

      setSuccess(true);
      setProducts([{ name:"", quantity:"" }]);
      setStaff([{ name:"", task:"Filleting","start":"","end":"" }]);
      setTotalSales("");
      setBinsGenerated("");
      setBinsDistributed("");
      setFormCompletedBy("");

      localStorage.clear();

    } catch (err) {
      alert(err.message);
    } finally {
      setLoading(false);
    }
  };

  /* ---------- SETUP ---------- */
  if (!configured) {
    return (
      <div className="min-h-screen flex items-center justify-center p-6">
        <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg">
          <h1 className="text-2xl font-bold mb-4">Initial Setup</h1>
          <input
            className="w-full border rounded px-3 py-2 mb-4"
            placeholder="Apps Script Web App URL"
            value={webAppUrl}
            onChange={e=>setWebAppUrl(e.target.value)}
          />
          <button
            className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded"
            onClick={()=>{
              localStorage.setItem("webAppUrl", webAppUrl);
              setConfigured(true);
            }}
          >
            Save & Continue
          </button>
        </div>
      </div>
    );
  }

  /* ---------- MAIN UI ---------- */
  return (
    <div className="max-w-5xl mx-auto p-4 md:p-8 space-y-6">
      {success && (
        <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white font-semibold px-6 py-3 rounded shadow-lg z-50">
          ✓ Report saved successfully
        </div>
      )}

      <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">

        <h1 className="text-3xl font-bold mb-6">Kai Ika Daily Report</h1>

        <form onSubmit={submit} className="space-y-6">

          {/* META */}
          <div className="grid md:grid-cols-3 gap-4">
            <input type="date" className="border rounded px-3 py-2 w-full" value={date} onChange={e=>setDate(e.target.value)} />
            <input type="text" className="border rounded px-3 py-2 w-full" placeholder="Form Completed By" value={formCompletedBy} onChange={e=>setFormCompletedBy(e.target.value)} />
            <input type="number" inputMode="numeric" step="0.01" placeholder="Total Sales ($)" className="border rounded px-3 py-2 w-full" value={totalSales} onChange={e=>setTotalSales(e.target.value)} />
          </div>

          {/* BINS */}
          <div className="grid md:grid-cols-2 gap-4">
            <input type="number" inputMode="numeric" placeholder="Bins Generated" className="border rounded px-3 py-2 w-full" value={binsGenerated} onChange={e=>setBinsGenerated(e.target.value)} />
            <input type="number" inputMode="numeric" placeholder="Bins Distributed" className="border rounded px-3 py-2 w-full" value={binsDistributed} onChange={e=>setBinsDistributed(e.target.value)} />
          </div>

          {/* PRODUCTS */}
          <section>
            <h2 className="font-semibold mb-3">Products</h2>
            {products.map((p,i)=>(
              <div key={i} className="grid grid-cols-3 gap-2 mb-2 items-center">
                <input list="products" className="border rounded px-3 py-2 col-span-2" placeholder="Product" value={p.name} onChange={e=>{ const x=[...products]; x[i].name=e.target.value; setProducts(x); }} />
                <div className="flex gap-2">
                  <input type="number" inputMode="numeric" className="border rounded px-3 py-2 w-full" placeholder="Qty" value={p.quantity} onChange={e=>{ const x=[...products]; x[i].quantity=e.target.value; setProducts(x); }} />
                  {products.length > 1 && <button type="button" className="text-red-500 font-bold px-2" onClick={()=>setProducts(products.filter((_,idx)=>idx!==i))}>×</button>}
                </div>
              </div>
            ))}
            <button type="button" className="text-blue-600 mt-2" onClick={()=>setProducts([...products,{name:"",quantity:""}])}>+ Add Product</button>
          </section>

          {/* STAFF */}
          <section>
            <h2 className="font-semibold mb-3">Staff</h2>
            {staff.map((s,i)=>(
              <div key={i} className="grid md:grid-cols-4 gap-2 mb-2 items-center">
                <input list="staff" className="border rounded px-3 py-2" placeholder="Name" value={s.name} onChange={e=>{ const x=[...staff]; x[i].name=e.target.value; setStaff(x); }} />
                <select className="border rounded px-3 py-2" value={s.task} onChange={e=>{ const x=[...staff]; x[i].task=e.target.value; setStaff(x); }}>
                  {TASKS.map(t=><option key={t}>{t}</option>)}
                </select>
                <input type="time" className="border rounded px-3 py-2" value={s.start} onChange={e=>{ const x=[...staff]; x[i].start=e.target.value; setStaff(x); }} />
                <input type="time" className="border rounded px-3 py-2" value={s.end} onChange={e=>{ const x=[...staff]; x[i].end=e.target.value; setStaff(x); }} />
                {staff.length > 1 && <button type="button" className="text-red-500 font-bold px-2" onClick={()=>setStaff(staff.filter((_,idx)=>idx!==i))}>×</button>}
              </div>
            ))}
            <button type="button" className="text-blue-600 mt-2" onClick={()=>setStaff([...staff,{name:"",task:"Filleting",start:"",end:""}])}>+ Add Staff</button>
          </section>

          <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white py-3 rounded-lg text-lg font-semibold">
            {loading ? "Saving…" : "Save Report"}
          </button>
        </form>
      </div>

      {/* DATA LISTS */}
      <datalist id="products">
        {PRODUCTS.map(p=><option key={p} value={p} />)}
      </datalist>
      <datalist id="staff">
        {STAFF.map(s=><option key={s} value={s} />)}
      </datalist>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById("root"));
</script>
</body>
</html>
