<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kai Ika – Daily Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-slate-50 to-cyan-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ---------- CONSTANT DATA ---------- */

const PRODUCTS = [
  "Blue Nose (LG)","Blue Nose (Sml)","Coke","Coke Zero","Crispy batter",
  "Donation","Gurnard","Hapuku (LG)","Hapuku (Sml)","John Dory","Kahawai",
  "Kai Ika Tee Shirt","King Fillet","King Steaked","Knife Gill & Gut",
  "Knife Set ($325)","Knife Single Filleting","Knife Single Skinning",
  "Knife Single Steaking","L&P","Mackeral","Mahi","Marlin Large",
  "Marlin Sml","Panko batter","Shake n Bake batter","Knife sharpening",
  "Sistema 3.8L","Snapper","SNA Scale & Fillet","SNA Scale Gut & Gill",
  "SNA Scale only","Sprite","Tarakihi","Tempura Batter","Trevally",
  "Tuna Lg","Tuna Med","Tuna SM","Other"
];

const STAFF = ["Ben","Connor","Dave","Opu","Matt","Jay","Other"];

const TASKS = ["Filleting","Distributions","Scotts","Cans","Other"];

/* ---------- APP ---------- */

function App() {
  const [webAppUrl, setWebAppUrl] = useState(localStorage.getItem("webAppUrl") || "");
  const [configured, setConfigured] = useState(!!localStorage.getItem("webAppUrl"));

  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);

  const [date, setDate] = useState(new Date().toISOString().slice(0,10));
  const [totalSales, setTotalSales] = useState("");
  const [binsGenerated, setBinsGenerated] = useState("");
  const [binsDistributed, setBinsDistributed] = useState("");

  const [products, setProducts] = useState([{ name:"", quantity:"" }]);
  const [staff, setStaff] = useState([{ name:"", task:"Filleting", hours:"" }]);

  /* ---------- SUBMIT ---------- */

  const submit = async e => {
    e.preventDefault();
    setLoading(true);
    setSuccess(false);

    try {
      const fd = new FormData();
      fd.append("date", date);
      fd.append("totalSales", totalSales);
      fd.append("binsGenerated", binsGenerated);
      fd.append("binsDistributed", binsDistributed);

      fd.append("productNames", products.map(p=>p.name).join("|||"));
      fd.append("productQtys", products.map(p=>p.quantity).join("|||"));

      fd.append("staffNames", staff.map(s=>s.name).join("|||"));
      fd.append("staffTasks", staff.map(s=>s.task).join("|||"));
      fd.append("staffHours", staff.map(s=>s.hours).join("|||"));

      const res = await fetch(webAppUrl, { method:"POST", body:fd });
      const json = await res.json();
      if (!json.success) throw new Error(json.error);

      setSuccess(true);
      setProducts([{ name:"", quantity:"" }]);
      setStaff([{ name:"", task:"Filleting", hours:"" }]);
      setTotalSales("");
      setBinsGenerated("");
      setBinsDistributed("");

    } catch (err) {
      alert(err.message);
    } finally {
      setLoading(false);
    }
  };

  /* ---------- SETUP ---------- */

  if (!configured) {
    return (
      <div className="min-h-screen flex items-center justify-center p-6">
        <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg">
          <h1 className="text-2xl font-bold mb-4">Initial Setup</h1>
          <input
            className="w-full border rounded px-3 py-2 mb-4"
            placeholder="Apps Script Web App URL"
            value={webAppUrl}
            onChange={e=>setWebAppUrl(e.target.value)}
          />
          <button
            className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded"
            onClick={()=>{
              localStorage.setItem("webAppUrl", webAppUrl);
              setConfigured(true);
            }}
          >
            Save & Continue
          </button>
        </div>
      </div>
    );
  }

  /* ---------- MAIN UI ---------- */

  return (
    <div className="max-w-5xl mx-auto p-4 md:p-8">
      <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8">

        <h1 className="text-3xl font-bold mb-6">Kai Ika Daily Report</h1>

        {success && (
          <div className="mb-4 p-3 bg-green-100 border border-green-300 rounded">
            ✓ Report saved successfully
          </div>
        )}

        <form onSubmit={submit} className="space-y-8">

          {/* META */}
          <div className="grid md:grid-cols-2 gap-4">
            <input type="date" className="border rounded px-3 py-2" value={date} onChange={e=>setDate(e.target.value)} />
            <input type="number" inputMode="numeric" step="0.01"
              placeholder="Total Sales ($)"
              className="border rounded px-3 py-2"
              value={totalSales}
              onChange={e=>setTotalSales(e.target.value)}
            />
          </div>

          {/* PRODUCTS */}
          <section>
            <h2 className="font-semibold mb-3">Products</h2>
            {products.map((p,i)=>(
              <div key={i} className="grid grid-cols-3 gap-2 mb-2">
                <input list="products"
                  className="border rounded px-3 py-2 col-span-2"
                  placeholder="Product"
                  value={p.name}
                  onChange={e=>{
                    const x=[...products]; x[i].name=e.target.value; setProducts(x);
                  }}
                />
                <input type="number" inputMode="numeric"
                  className="border rounded px-3 py-2"
                  placeholder="Qty"
                  value={p.quantity}
                  onChange={e=>{
                    const x=[...products]; x[i].quantity=e.target.value; setProducts(x);
                  }}
                />
              </div>
            ))}
            <button type="button" className="text-blue-600" onClick={()=>setProducts([...products,{name:"",quantity:""}])}>
              + Add product
            </button>
          </section>

          {/* STAFF */}
          <section>
            <h2 className="font-semibold mb-3">Staff</h2>
            {staff.map((s,i)=>(
              <div key={i} className="grid grid-cols-3 gap-2 mb-2">
                <input list="staff"
                  className="border rounded px-3 py-2"
                  placeholder="Name"
                  value={s.name}
                  onChange={e=>{
                    const x=[...staff]; x[i].name=e.target.value; setStaff(x);
                  }}
                />
                <select className="border rounded px-3 py-2"
                  value={s.task}
                  onChange={e=>{
                    const x=[...staff]; x[i].task=e.target.value; setStaff(x);
                  }}
                >
                  {TASKS.map(t=><option key={t}>{t}</option>)}
                </select>
                <input type="number" inputMode="numeric" step="0.25"
                  className="border rounded px-3 py-2"
                  placeholder="Hours"
                  value={s.hours}
                  onChange={e=>{
                    const x=[...staff]; x[i].hours=e.target.value; setStaff(x);
                  }}
                />
              </div>
            ))}
            <button type="button" className="text-blue-600" onClick={()=>setStaff([...staff,{name:"",task:"Filleting",hours:""}])}>
              + Add staff
            </button>
          </section>

          {/* BINS */}
          <div className="grid md:grid-cols-2 gap-4">
            <input type="number" inputMode="numeric"
              placeholder="Bins Generated"
              className="border rounded px-3 py-2"
              value={binsGenerated}
              onChange={e=>setBinsGenerated(e.target.value)}
            />
            <input type="number" inputMode="numeric"
              placeholder="Bins Distributed"
              className="border rounded px-3 py-2"
              value={binsDistributed}
              onChange={e=>setBinsDistributed(e.target.value)}
            />
          </div>

          <button disabled={loading}
            className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white py-3 rounded-lg text-lg font-semibold">
            {loading ? "Saving…" : "Save Report"}
          </button>

        </form>
      </div>

      {/* DATA LISTS */}
      <datalist id="products">
        {PRODUCTS.map(p=><option key={p} value={p} />)}
      </datalist>
      <datalist id="staff">
        {STAFF.map(s=><option key={s} value={s} />)}
      </datalist>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById("root"));
</script>
</body>
</html>
